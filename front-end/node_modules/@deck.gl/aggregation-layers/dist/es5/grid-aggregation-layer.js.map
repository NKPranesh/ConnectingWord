{"version":3,"sources":["../../src/grid-aggregation-layer.js"],"names":["GridAggregationLayer","AggregationLayer","initializeState","dimensions","gl","context","setState","layerData","gpuGridAggregator","GPUGridAggregator","id","cpuGridAggregator","pointToDensityGridDataCPU","updateState","opts","updateAggregationState","aggregationDataDirty","aggregationWeightsDirty","gpuAggregation","state","getNumInstances","aggregationDirty","_updateAggregation","_updateWeightBins","_uploadAggregationResults","finalizeState","count","weights","aggregationBuffer","delete","updateShaders","shaders","log","assert","allocateResources","numRow","numCol","dataBytes","name","weight","Buffer","byteLength","accessor","size","type","divisor","updateResults","aggregationData","maxMinData","maxData","minData","gridOffset","posOffset","translation","scaling","boundingBox","projectPoints","props","viewport","attributes","getAttributes","vertexCount","result","run","cellSize","xOffset","yOffset","moduleSettings","getModuleSettings","getValue","sortedBins","BinSorter","data","aggregatedBins","minValue","maxValue","totalCount","ELEMENTCOUNT","aggregationSize","Float32Array","fill","bin","lonIdx","latIdx","i","value","counts","cellIndex","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport AggregationLayer from './aggregation-layer';\nimport GPUGridAggregator from './utils/gpu-grid-aggregation/gpu-grid-aggregator';\nimport {Buffer} from '@luma.gl/core';\nimport {log} from '@deck.gl/core';\nimport GL from '@luma.gl/constants';\nimport BinSorter from './utils/bin-sorter';\nimport {pointToDensityGridDataCPU} from './cpu-grid-layer/grid-aggregator';\n\nexport default class GridAggregationLayer extends AggregationLayer {\n  initializeState({dimensions}) {\n    const {gl} = this.context;\n    super.initializeState(dimensions);\n    this.setState({\n      // CPU aggregation results\n      layerData: {},\n      gpuGridAggregator: new GPUGridAggregator(gl, {id: `${this.id}-gpu-aggregator`}),\n      cpuGridAggregator: pointToDensityGridDataCPU\n    });\n  }\n\n  updateState(opts) {\n    // get current attributes\n    super.updateState(opts);\n\n    this.updateAggregationState(opts);\n\n    const {aggregationDataDirty, aggregationWeightsDirty, gpuAggregation} = this.state;\n    if (this.getNumInstances() <= 0) {\n      return;\n    }\n    let aggregationDirty = false;\n    // CPU aggregation is two steps\n    // 1. Create bins (based on cellSize and position) 2. Aggregate weights for each bin\n    // For GPU aggregation both above steps are combined into one step\n\n    // step-1\n    if (aggregationDataDirty || (gpuAggregation && aggregationWeightsDirty)) {\n      this._updateAggregation(opts);\n      aggregationDirty = true;\n    }\n    // step-2 (Applicalbe for CPU aggregation only)\n    if (!gpuAggregation && (aggregationDataDirty || aggregationWeightsDirty)) {\n      this._updateWeightBins();\n      this._uploadAggregationResults();\n      aggregationDirty = true;\n    }\n\n    this.setState({aggregationDirty});\n  }\n\n  finalizeState() {\n    const {count} = this.state.weights;\n    if (count && count.aggregationBuffer) {\n      count.aggregationBuffer.delete();\n    }\n    this.state.gpuGridAggregator?.delete();\n    super.finalizeState();\n  }\n\n  updateShaders(shaders) {\n    if (this.state.gpuAggregation) {\n      this.state.gpuGridAggregator.updateShaders(shaders);\n    }\n  }\n\n  // Methods that can be overriden by subclasses for customizations\n\n  updateAggregationState(opts) {\n    // Sublayers should implement this method.\n    log.assert(false);\n  }\n\n  allocateResources(numRow, numCol) {\n    if (this.state.numRow !== numRow || this.state.numCol !== numCol) {\n      const dataBytes = numCol * numRow * 4 * 4;\n      const gl = this.context.gl;\n      const {weights} = this.state;\n      for (const name in weights) {\n        const weight = weights[name];\n        if (weight.aggregationBuffer) {\n          weight.aggregationBuffer.delete();\n        }\n        weight.aggregationBuffer = new Buffer(gl, {\n          byteLength: dataBytes,\n          accessor: {\n            size: 4,\n            type: GL.FLOAT,\n            divisor: 1\n          }\n        });\n      }\n    }\n  }\n\n  updateResults({aggregationData, maxMinData, maxData, minData}) {\n    const {count} = this.state.weights;\n    if (count) {\n      count.aggregationData = aggregationData;\n      count.maxMinData = maxMinData;\n      count.maxData = maxData;\n      count.minData = minData;\n    }\n  }\n\n  // Private\n\n  _updateAggregation(opts) {\n    const {\n      cpuGridAggregator,\n      gpuGridAggregator,\n      gridOffset,\n      posOffset,\n      translation = [0, 0],\n      scaling = [0, 0, 0],\n      boundingBox,\n      projectPoints,\n      gpuAggregation,\n      numCol,\n      numRow\n    } = this.state;\n    const {props} = opts;\n    const {viewport} = this.context;\n    const attributes = this.getAttributes();\n    const vertexCount = this.getNumInstances();\n\n    if (!gpuAggregation) {\n      const result = cpuGridAggregator(props, {\n        gridOffset,\n        projectPoints,\n        attributes,\n        viewport,\n        posOffset,\n        boundingBox\n      });\n      this.setState({\n        layerData: result\n      });\n    } else {\n      const {weights} = this.state;\n      gpuGridAggregator.run({\n        weights,\n        cellSize: [gridOffset.xOffset, gridOffset.yOffset],\n        numCol,\n        numRow,\n        translation,\n        scaling,\n        vertexCount,\n        projectPoints,\n        attributes,\n        moduleSettings: this.getModuleSettings()\n      });\n    }\n  }\n\n  _updateWeightBins() {\n    const {getValue} = this.state;\n\n    const sortedBins = new BinSorter(this.state.layerData.data || [], {getValue});\n    this.setState({sortedBins});\n  }\n\n  _uploadAggregationResults() {\n    const {numCol, numRow} = this.state;\n    const {data} = this.state.layerData;\n    const {aggregatedBins, minValue, maxValue, totalCount} = this.state.sortedBins;\n\n    const ELEMENTCOUNT = 4;\n    const aggregationSize = numCol * numRow * ELEMENTCOUNT;\n    const aggregationData = new Float32Array(aggregationSize).fill(0);\n    for (const bin of aggregatedBins) {\n      const {lonIdx, latIdx} = data[bin.i];\n      const {value, counts} = bin;\n      const cellIndex = (lonIdx + latIdx * numCol) * ELEMENTCOUNT;\n      aggregationData[cellIndex] = value;\n      aggregationData[cellIndex + ELEMENTCOUNT - 1] = counts;\n    }\n    const maxMinData = new Float32Array([maxValue, 0, 0, minValue]);\n    const maxData = new Float32Array([maxValue, 0, 0, totalCount]);\n    const minData = new Float32Array([minValue, 0, 0, totalCount]);\n    this.updateResults({aggregationData, maxMinData, maxData, minData});\n  }\n}\n\nGridAggregationLayer.layerName = 'GridAggregationLayer';\n"],"file":"grid-aggregation-layer.js"}