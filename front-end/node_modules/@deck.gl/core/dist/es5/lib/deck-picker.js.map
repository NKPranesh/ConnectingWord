{"version":3,"sources":["../../../src/lib/deck-picker.js"],"names":["DeckPicker","constructor","gl","pickingFBO","pickLayersPass","PickLayersPass","layerFilter","lastPickedInfo","index","layerId","info","setProps","props","_pickable","finalize","delete","depthFBO","color","pickObject","opts","_pickClosestObject","pickObjects","_pickVisibleObjects","getLastPickedObject","x","y","layers","viewports","lastPickedLayerId","layer","id","lastPickedViewportId","viewport","find","l","v","coordinate","unproject","_resizeBuffer","Framebuffer","isSupported","colorBufferFloat","attach","Texture2D","format","type","resize","width","canvas","height","_getPickable","pickableLayers","filter","isPickable","isComposite","length","views","radius","depth","mode","unproject3D","onViewportActive","result","emptyInfo","pixelRatio","devicePixelRange","devicePixel","Math","floor","deviceRadius","round","deviceRect","_getPickingRect","deviceX","deviceY","deviceWidth","deviceHeight","infos","affectedLayers","Set","i","pickedResult","_drawAndSample","pass","redrawReason","pickInfo","z","pickedLayer","pickedResultPass2","pickedX","pickedY","pickZ","pickedColors","distanceScales","metersPerUnit","position","add","disablePickingIndex","pickedObjectIndex","values","push","pickedColor","restorePickingColors","get","maxObjects","leftTop","deviceLeft","deviceTop","rightBottom","deviceRight","deviceBottom","pickInfos","uniqueInfos","Map","isMaxObjects","Number","isFinite","size","picked","has","object","set","Array","from","decodePickingColor","render","Float32Array","Uint8Array","sourceX","sourceY","sourceWidth","sourceHeight","target","max","min"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {\n  Framebuffer,\n  Texture2D,\n  isWebGL2,\n  readPixelsToArray,\n  cssToDeviceRatio,\n  cssToDevicePixels\n} from '@luma.gl/core';\nimport GL from '@luma.gl/constants';\nimport PickLayersPass from '../passes/pick-layers-pass';\nimport {getClosestObject, getUniqueObjects} from './picking/query-object';\nimport {processPickInfo, getLayerPickingInfo, getEmptyPickingInfo} from './picking/pick-info';\n\nexport default class DeckPicker {\n  constructor(gl) {\n    this.gl = gl;\n    this.pickingFBO = null;\n    this.pickLayersPass = new PickLayersPass(gl);\n    this.layerFilter = null;\n    this.lastPickedInfo = {\n      // For callback tracking and auto highlight\n      index: -1,\n      layerId: null,\n      info: null\n    };\n  }\n\n  setProps(props) {\n    if ('layerFilter' in props) {\n      this.layerFilter = props.layerFilter;\n    }\n\n    if ('_pickable' in props) {\n      this._pickable = props._pickable;\n    }\n  }\n\n  finalize() {\n    if (this.pickingFBO) {\n      this.pickingFBO.delete();\n    }\n    if (this.depthFBO) {\n      this.depthFBO.color.delete();\n      this.depthFBO.delete();\n    }\n  }\n\n  // Pick the closest info at given coordinate\n  pickObject(opts) {\n    return this._pickClosestObject(opts);\n  }\n\n  // Get all unique infos within a bounding box\n  pickObjects(opts) {\n    return this._pickVisibleObjects(opts);\n  }\n\n  // Returns a new picking info object by assuming the last picked object is still picked\n  getLastPickedObject({x, y, layers, viewports}, lastPickedInfo = this.lastPickedInfo.info) {\n    const lastPickedLayerId = lastPickedInfo && lastPickedInfo.layer && lastPickedInfo.layer.id;\n    const lastPickedViewportId =\n      lastPickedInfo && lastPickedInfo.viewport && lastPickedInfo.viewport.id;\n    const layer = lastPickedLayerId ? layers.find(l => l.id === lastPickedLayerId) : null;\n    const viewport =\n      (lastPickedViewportId && viewports.find(v => v.id === lastPickedViewportId)) || viewports[0];\n    const coordinate = viewport && viewport.unproject([x - viewport.x, y - viewport.y]);\n\n    const info = {\n      x,\n      y,\n      viewport,\n      coordinate,\n      layer\n    };\n\n    return {...lastPickedInfo, ...info};\n  }\n\n  // Private\n  _resizeBuffer() {\n    const {gl} = this;\n\n    // Create a frame buffer if not already available\n    if (!this.pickingFBO) {\n      this.pickingFBO = new Framebuffer(gl);\n      if (Framebuffer.isSupported(gl, {colorBufferFloat: true})) {\n        this.depthFBO = new Framebuffer(gl);\n        this.depthFBO.attach({\n          [GL.COLOR_ATTACHMENT0]: new Texture2D(gl, {\n            format: isWebGL2(gl) ? GL.RGBA32F : GL.RGBA,\n            type: GL.FLOAT\n          })\n        });\n      }\n    }\n    // Resize it to current canvas size (this is a noop if size hasn't changed)\n    this.pickingFBO.resize({width: gl.canvas.width, height: gl.canvas.height});\n    if (this.depthFBO) {\n      this.depthFBO.resize({width: gl.canvas.width, height: gl.canvas.height});\n    }\n    return this.pickingFBO;\n  }\n\n  // picking can only handle up to 255 layers. Drop non-pickable/invisible layers from the list.\n  _getPickable(layers) {\n    if (this._pickable === false) {\n      return null;\n    }\n    const pickableLayers = layers.filter(layer => layer.isPickable() && !layer.isComposite);\n    return pickableLayers.length ? pickableLayers : null;\n  }\n\n  // Pick the closest object at the given (x,y) coordinate\n  // eslint-disable-next-line max-statements,complexity\n  _pickClosestObject({\n    layers,\n    views,\n    viewports,\n    x,\n    y,\n    radius = 0,\n    depth = 1,\n    mode = 'query',\n    unproject3D,\n    onViewportActive\n  }) {\n    layers = this._getPickable(layers);\n\n    if (!layers) {\n      return {\n        result: [],\n        emptyInfo: getEmptyPickingInfo({viewports, x, y})\n      };\n    }\n\n    this._resizeBuffer();\n\n    // Convert from canvas top-left to WebGL bottom-left coordinates\n    // Top-left coordinates [x, y] to bottom-left coordinates [deviceX, deviceY]\n    // And compensate for pixelRatio\n    const pixelRatio = cssToDeviceRatio(this.gl);\n    const devicePixelRange = cssToDevicePixels(this.gl, [x, y], true);\n    const devicePixel = [\n      devicePixelRange.x + Math.floor(devicePixelRange.width / 2),\n      devicePixelRange.y + Math.floor(devicePixelRange.height / 2)\n    ];\n\n    const deviceRadius = Math.round(radius * pixelRatio);\n    const {width, height} = this.pickingFBO;\n    const deviceRect = this._getPickingRect({\n      deviceX: devicePixel[0],\n      deviceY: devicePixel[1],\n      deviceRadius,\n      deviceWidth: width,\n      deviceHeight: height\n    });\n\n    let infos;\n    const result = [];\n    const affectedLayers = new Set();\n\n    for (let i = 0; i < depth; i++) {\n      const pickedResult =\n        deviceRect &&\n        this._drawAndSample({\n          layers,\n          views,\n          viewports,\n          onViewportActive,\n          deviceRect,\n          pass: `picking:${mode}`,\n          redrawReason: mode\n        });\n\n      const pickInfo = getClosestObject({\n        ...pickedResult,\n        deviceX: devicePixel[0],\n        deviceY: devicePixel[1],\n        deviceRadius,\n        deviceRect\n      });\n\n      let z;\n      if (pickInfo.pickedLayer && unproject3D && this.depthFBO) {\n        const pickedResultPass2 = this._drawAndSample({\n          layers: [pickInfo.pickedLayer],\n          views,\n          viewports,\n          onViewportActive,\n          deviceRect: {x: pickInfo.pickedX, y: pickInfo.pickedY, width: 1, height: 1},\n          pass: `picking:${mode}`,\n          redrawReason: 'pick-z',\n          pickZ: true\n        });\n        // picked value is in common space (pixels) from the camera target (viewport.position)\n        // convert it to meters from the ground\n        z =\n          pickedResultPass2.pickedColors[0] * viewports[0].distanceScales.metersPerUnit[2] +\n          viewports[0].position[2];\n      }\n\n      // Only exclude if we need to run picking again.\n      // We need to run picking again if an object is detected AND\n      // we have not exhausted the requested depth.\n      if (pickInfo.pickedLayer && i + 1 < depth) {\n        affectedLayers.add(pickInfo.pickedLayer);\n        pickInfo.pickedLayer.disablePickingIndex(pickInfo.pickedObjectIndex);\n      }\n\n      // This logic needs to run even if no object is picked.\n      infos = processPickInfo({\n        pickInfo,\n        lastPickedInfo: this.lastPickedInfo,\n        mode,\n        layers,\n        viewports,\n        x,\n        y,\n        z,\n        pixelRatio\n      });\n\n      for (const info of infos.values()) {\n        if (info.layer) {\n          result.push(info);\n        }\n      }\n\n      // If no object is picked stop.\n      if (!pickInfo.pickedColor) {\n        break;\n      }\n    }\n\n    // reset only affected buffers\n    for (const layer of affectedLayers) {\n      layer.restorePickingColors();\n    }\n\n    return {result, emptyInfo: infos && infos.get(null)};\n  }\n\n  // Pick all objects within the given bounding box\n  _pickVisibleObjects({\n    layers,\n    views,\n    viewports,\n    x,\n    y,\n    width = 1,\n    height = 1,\n    mode = 'query',\n    maxObjects = null,\n    onViewportActive\n  }) {\n    layers = this._getPickable(layers);\n\n    if (!layers) {\n      return [];\n    }\n\n    this._resizeBuffer();\n    // Convert from canvas top-left to WebGL bottom-left coordinates\n    // And compensate for pixelRatio\n    const pixelRatio = cssToDeviceRatio(this.gl);\n    const leftTop = cssToDevicePixels(this.gl, [x, y], true);\n\n    // take left and top (y inverted in device pixels) from start location\n    const deviceLeft = leftTop.x;\n    const deviceTop = leftTop.y + leftTop.height;\n\n    // take right and bottom (y inverted in device pixels) from end location\n    const rightBottom = cssToDevicePixels(this.gl, [x + width, y + height], true);\n    const deviceRight = rightBottom.x + rightBottom.width;\n    const deviceBottom = rightBottom.y;\n\n    const deviceRect = {\n      x: deviceLeft,\n      y: deviceBottom,\n      // deviceTop and deviceRight represent the first pixel outside the desired rect\n      width: deviceRight - deviceLeft,\n      height: deviceTop - deviceBottom\n    };\n\n    const pickedResult = this._drawAndSample({\n      layers,\n      views,\n      viewports,\n      onViewportActive,\n      deviceRect,\n      pass: `picking:${mode}`,\n      redrawReason: mode\n    });\n\n    const pickInfos = getUniqueObjects(pickedResult);\n\n    // Only return unique infos, identified by info.object\n    const uniqueInfos = new Map();\n\n    const isMaxObjects = Number.isFinite(maxObjects);\n\n    for (let i = 0; i < pickInfos.length; i++) {\n      if (isMaxObjects && uniqueInfos.size >= maxObjects) {\n        break;\n      }\n      const pickInfo = pickInfos[i];\n      let info = {\n        color: pickInfo.pickedColor,\n        layer: null,\n        index: pickInfo.pickedObjectIndex,\n        picked: true,\n        x,\n        y,\n        width,\n        height,\n        pixelRatio\n      };\n\n      info = getLayerPickingInfo({layer: pickInfo.pickedLayer, info, mode});\n      if (!uniqueInfos.has(info.object)) {\n        uniqueInfos.set(info.object, info);\n      }\n    }\n\n    return Array.from(uniqueInfos.values());\n  }\n\n  // returns pickedColor or null if no pickable layers found.\n  _drawAndSample({\n    layers,\n    views,\n    viewports,\n    onViewportActive,\n    deviceRect,\n    pass,\n    redrawReason,\n    pickZ\n  }) {\n    const pickingFBO = pickZ ? this.depthFBO : this.pickingFBO;\n\n    const {decodePickingColor} = this.pickLayersPass.render({\n      layers,\n      layerFilter: this.layerFilter,\n      views,\n      viewports,\n      onViewportActive,\n      pickingFBO,\n      deviceRect,\n      pass,\n      redrawReason,\n      pickZ\n    });\n\n    // Read from an already rendered picking buffer\n    // Returns an Uint8ClampedArray of picked pixels\n    const {x, y, width, height} = deviceRect;\n    const pickedColors = new (pickZ ? Float32Array : Uint8Array)(width * height * 4);\n    readPixelsToArray(pickingFBO, {\n      sourceX: x,\n      sourceY: y,\n      sourceWidth: width,\n      sourceHeight: height,\n      target: pickedColors\n    });\n\n    return {pickedColors, decodePickingColor};\n  }\n\n  // Calculate a picking rect centered on deviceX and deviceY and clipped to device\n  // Returns null if pixel is outside of device\n  _getPickingRect({deviceX, deviceY, deviceRadius, deviceWidth, deviceHeight}) {\n    // Create a box of size `radius * 2 + 1` centered at [deviceX, deviceY]\n    const x = Math.max(0, deviceX - deviceRadius);\n    const y = Math.max(0, deviceY - deviceRadius);\n    const width = Math.min(deviceWidth, deviceX + deviceRadius + 1) - x;\n    const height = Math.min(deviceHeight, deviceY + deviceRadius + 1) - y;\n\n    // x, y out of bounds.\n    if (width <= 0 || height <= 0) {\n      return null;\n    }\n\n    return {x, y, width, height};\n  }\n}\n"],"file":"deck-picker.js"}