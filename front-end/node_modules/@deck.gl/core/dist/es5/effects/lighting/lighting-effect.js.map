{"version":3,"sources":["../../../../src/effects/lighting/lighting-effect.js"],"names":["DEFAULT_AMBIENT_LIGHT_PROPS","color","intensity","DEFAULT_DIRECTIONAL_LIGHT_PROPS","direction","DEFAULT_SHADOW_COLOR","LightingEffect","Effect","constructor","props","ambientLight","directionalLights","pointLights","shadowColor","shadowPasses","shadowMaps","dummyShadowMap","shadow","programManager","key","lightSource","type","push","_applyDefaultLights","some","light","preRender","gl","layers","layerFilter","viewports","onViewportActive","views","shadowMatrices","_createLightMatrix","length","_createShadowPasses","ProgramManager","getDefaultProgramManager","addDefaultModule","Texture2D","width","height","i","shadowPass","render","moduleParameters","shadowLightId","getModuleParameters","layer","parameters","lightSources","map","directionalLight","getProjectedLight","pointLight","cleanup","delete","removeDefaultModule","lightMatrices","viewMatrix","Matrix4","lookAt","eye","Vector3","negate","ShadowPass","shadowMap","AmbientLight","DirectionalLight"],"mappings":"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","sourcesContent":["import {Texture2D, ProgramManager} from '@luma.gl/core';\nimport {AmbientLight} from './ambient-light';\nimport {DirectionalLight} from './directional-light';\nimport Effect from '../../lib/effect';\nimport {Matrix4, Vector3} from 'math.gl';\nimport ShadowPass from '../../passes/shadow-pass';\nimport {default as shadow} from '../../shaderlib/shadow/shadow';\n\nconst DEFAULT_AMBIENT_LIGHT_PROPS = {color: [255, 255, 255], intensity: 1.0};\nconst DEFAULT_DIRECTIONAL_LIGHT_PROPS = [\n  {\n    color: [255, 255, 255],\n    intensity: 1.0,\n    direction: [-1, 3, -1]\n  },\n  {\n    color: [255, 255, 255],\n    intensity: 0.9,\n    direction: [1, -8, -2.5]\n  }\n];\nconst DEFAULT_SHADOW_COLOR = [0, 0, 0, 200 / 255];\n\n// Class to manage ambient, point and directional light sources in deck\nexport default class LightingEffect extends Effect {\n  constructor(props) {\n    super(props);\n    this.ambientLight = null;\n    this.directionalLights = [];\n    this.pointLights = [];\n\n    this.shadowColor = DEFAULT_SHADOW_COLOR;\n    this.shadowPasses = [];\n    this.shadowMaps = [];\n    this.dummyShadowMap = null;\n    this.shadow = false;\n    this.programManager = null;\n\n    for (const key in props) {\n      const lightSource = props[key];\n\n      switch (lightSource.type) {\n        case 'ambient':\n          this.ambientLight = lightSource;\n          break;\n\n        case 'directional':\n          this.directionalLights.push(lightSource);\n          break;\n\n        case 'point':\n          this.pointLights.push(lightSource);\n          break;\n        default:\n      }\n    }\n    this._applyDefaultLights();\n\n    this.shadow = this.directionalLights.some(light => light.shadow);\n  }\n\n  preRender(gl, {layers, layerFilter, viewports, onViewportActive, views}) {\n    if (!this.shadow) return;\n\n    // create light matrix every frame to make sure always updated from light source\n    this.shadowMatrices = this._createLightMatrix();\n\n    if (this.shadowPasses.length === 0) {\n      this._createShadowPasses(gl);\n    }\n    if (!this.programManager) {\n      // TODO - support multiple contexts\n      this.programManager = ProgramManager.getDefaultProgramManager(gl);\n      if (shadow) {\n        this.programManager.addDefaultModule(shadow);\n      }\n    }\n\n    if (!this.dummyShadowMap) {\n      this.dummyShadowMap = new Texture2D(gl, {\n        width: 1,\n        height: 1\n      });\n    }\n\n    for (let i = 0; i < this.shadowPasses.length; i++) {\n      const shadowPass = this.shadowPasses[i];\n      shadowPass.render({\n        layers,\n        layerFilter,\n        viewports,\n        onViewportActive,\n        views,\n        moduleParameters: {\n          shadowLightId: i,\n          dummyShadowMap: this.dummyShadowMap,\n          shadowMatrices: this.shadowMatrices\n        }\n      });\n    }\n  }\n\n  getModuleParameters(layer) {\n    const parameters = this.shadow\n      ? {\n          shadowMaps: this.shadowMaps,\n          dummyShadowMap: this.dummyShadowMap,\n          shadowColor: this.shadowColor,\n          shadowMatrices: this.shadowMatrices\n        }\n      : {};\n\n    // when not rendering to screen, turn off lighting by adding empty light source object\n    // lights shader module relies on the `lightSources` to turn on/off lighting\n    parameters.lightSources = {\n      ambientLight: this.ambientLight,\n      directionalLights: this.directionalLights.map(directionalLight =>\n        directionalLight.getProjectedLight({layer})\n      ),\n      pointLights: this.pointLights.map(pointLight => pointLight.getProjectedLight({layer}))\n    };\n\n    return parameters;\n  }\n\n  cleanup() {\n    for (const shadowPass of this.shadowPasses) {\n      shadowPass.delete();\n    }\n    this.shadowPasses.length = 0;\n    this.shadowMaps.length = 0;\n\n    if (this.dummyShadowMap) {\n      this.dummyShadowMap.delete();\n      this.dummyShadowMap = null;\n    }\n\n    if (this.shadow && this.programManager) {\n      this.programManager.removeDefaultModule(shadow);\n      this.programManager = null;\n    }\n  }\n\n  _createLightMatrix() {\n    const lightMatrices = [];\n    for (const light of this.directionalLights) {\n      const viewMatrix = new Matrix4().lookAt({\n        eye: new Vector3(light.direction).negate()\n      });\n\n      lightMatrices.push(viewMatrix);\n    }\n    return lightMatrices;\n  }\n\n  _createShadowPasses(gl) {\n    for (let i = 0; i < this.directionalLights.length; i++) {\n      const shadowPass = new ShadowPass(gl);\n      this.shadowPasses[i] = shadowPass;\n      this.shadowMaps[i] = shadowPass.shadowMap;\n    }\n  }\n\n  _applyDefaultLights() {\n    const {ambientLight, pointLights, directionalLights} = this;\n    if (!ambientLight && pointLights.length === 0 && directionalLights.length === 0) {\n      this.ambientLight = new AmbientLight(DEFAULT_AMBIENT_LIGHT_PROPS);\n      this.directionalLights.push(\n        new DirectionalLight(DEFAULT_DIRECTIONAL_LIGHT_PROPS[0]),\n        new DirectionalLight(DEFAULT_DIRECTIONAL_LIGHT_PROPS[1])\n      );\n    }\n  }\n}\n"],"file":"lighting-effect.js"}