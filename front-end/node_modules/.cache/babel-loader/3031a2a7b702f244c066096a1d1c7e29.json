{"ast":null,"code":"import { polyfillVertexArrayObject } from './polyfill-vertex-array-object';\nimport { assert } from '../utils/assert';\nimport { WEBGL2_CONTEXT_POLYFILLS, WEBGL2_CONTEXT_OVERRIDES } from './polyfill-table';\nexport function polyfillContext(gl) {\n  gl.luma = gl.luma || {};\n  const {\n    luma\n  } = gl;\n\n  if (!luma.polyfilled) {\n    polyfillVertexArrayObject(gl);\n    initializeExtensions(gl);\n    installPolyfills(gl, WEBGL2_CONTEXT_POLYFILLS);\n    installOverrides(gl, {\n      target: luma,\n      target2: gl\n    });\n    luma.polyfilled = true;\n  }\n\n  return gl;\n}\nconst global_ = typeof global !== 'undefined' ? global : window;\nglobal_.polyfillContext = polyfillContext;\n\nfunction initializeExtensions(gl) {\n  gl.luma.extensions = {};\n  const EXTENSIONS = gl.getSupportedExtensions() || [];\n\n  for (const extension of EXTENSIONS) {\n    gl.luma[extension] = gl.getExtension(extension);\n  }\n}\n\nfunction installOverrides(gl, _ref) {\n  let {\n    target,\n    target2\n  } = _ref;\n  Object.keys(WEBGL2_CONTEXT_OVERRIDES).forEach(key => {\n    if (typeof WEBGL2_CONTEXT_OVERRIDES[key] === 'function') {\n      const originalFunc = gl[key] ? gl[key].bind(gl) : () => {};\n      const polyfill = WEBGL2_CONTEXT_OVERRIDES[key].bind(null, gl, originalFunc);\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  });\n}\n\nfunction installPolyfills(gl, polyfills) {\n  for (const extension of Object.getOwnPropertyNames(polyfills)) {\n    if (extension !== 'overrides') {\n      polyfillExtension(gl, {\n        extension,\n        target: gl.luma,\n        target2: gl\n      });\n    }\n  }\n}\n\nfunction polyfillExtension(gl, _ref2) {\n  let {\n    extension,\n    target,\n    target2\n  } = _ref2;\n  const defaults = WEBGL2_CONTEXT_POLYFILLS[extension];\n  assert(defaults);\n  const {\n    meta = {}\n  } = defaults;\n  const {\n    suffix = ''\n  } = meta;\n  const ext = gl.getExtension(extension);\n\n  for (const key of Object.keys(defaults)) {\n    const extKey = `${key}${suffix}`;\n    let polyfill = null;\n\n    if (key === 'meta') {} else if (typeof gl[key] === 'function') {} else if (ext && typeof ext[extKey] === 'function') {\n      polyfill = function () {\n        return ext[extKey](...arguments);\n      };\n    } else if (typeof defaults[key] === 'function') {\n      polyfill = defaults[key].bind(target);\n    }\n\n    if (polyfill) {\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  }\n}","map":{"version":3,"sources":["../../../src/polyfill/polyfill-context.js"],"names":["gl","luma","polyfillVertexArrayObject","initializeExtensions","installPolyfills","installOverrides","target","target2","global_","EXTENSIONS","Object","key","WEBGL2_CONTEXT_OVERRIDES","originalFunc","polyfill","extension","polyfillExtension","defaults","WEBGL2_CONTEXT_POLYFILLS","assert","meta","suffix","ext","extKey"],"mappings":"AAWA,SAAA,yBAAA,QAAA,gCAAA;AACA,SAAA,MAAA,QAAA,iBAAA;AAEA,SAAA,wBAAA,EAAA,wBAAA,QAAA,kBAAA;AAGA,OAAO,SAAA,eAAA,CAAA,EAAA,EAA6B;AAElCA,EAAAA,EAAE,CAAFA,IAAAA,GAAUA,EAAE,CAAFA,IAAAA,IAAVA,EAAAA;AAEA,QAAM;AAACC,IAAAA;AAAD,MAAN,EAAA;;AAEA,MAAI,CAACA,IAAI,CAAT,UAAA,EAAsB;AACpBC,IAAAA,yBAAyB,CAAzBA,EAAyB,CAAzBA;AACAC,IAAAA,oBAAoB,CAApBA,EAAoB,CAApBA;AACAC,IAAAA,gBAAgB,CAAA,EAAA,EAAhBA,wBAAgB,CAAhBA;AACAC,IAAAA,gBAAgB,CAAA,EAAA,EAAK;AAACC,MAAAA,MAAM,EAAP,IAAA;AAAeC,MAAAA,OAAO,EAAEP;AAAxB,KAAL,CAAhBK;AACAJ,IAAAA,IAAI,CAAJA,UAAAA,GAAAA,IAAAA;AACD;;AAKD,SAAA,EAAA;AACD;AAGD,MAAMO,OAAO,GAAG,OAAA,MAAA,KAAA,WAAA,GAAA,MAAA,GAAhB,MAAA;AAEAA,OAAO,CAAPA,eAAAA,GAAAA,eAAAA;;AAEA,SAAA,oBAAA,CAAA,EAAA,EAAkC;AAChCR,EAAAA,EAAE,CAAFA,IAAAA,CAAAA,UAAAA,GAAAA,EAAAA;AAEA,QAAMS,UAAU,GAAGT,EAAE,CAAFA,sBAAAA,MAAnB,EAAA;;AACA,OAAK,MAAL,SAAA,IAAA,UAAA,EAAoC;AAClCA,IAAAA,EAAE,CAAFA,IAAAA,CAAAA,SAAAA,IAAqBA,EAAE,CAAFA,YAAAA,CAArBA,SAAqBA,CAArBA;AACD;AACF;;AAGD,SAAA,gBAAA,CAAA,EAAA,QAAiD;AAAA,MAAnB;AAAA,IAAA,MAAA;AAASO,IAAAA;AAAT,GAAmB;AAC/CG,EAAAA,MAAM,CAANA,IAAAA,CAAAA,wBAAAA,EAAAA,OAAAA,CAA8CC,GAAG,IAAI;AACnD,QAAI,OAAOC,wBAAwB,CAA/B,GAA+B,CAA/B,KAAJ,UAAA,EAAyD;AAEvD,YAAMC,YAAY,GAAGb,EAAE,CAAFA,GAAE,CAAFA,GAAUA,EAAE,CAAFA,GAAE,CAAFA,CAAAA,IAAAA,CAAVA,EAAUA,CAAVA,GAA6B,MAAM,CAAxD,CAAA;AACA,YAAMc,QAAQ,GAAGF,wBAAwB,CAAxBA,GAAwB,CAAxBA,CAAAA,IAAAA,CAAAA,IAAAA,EAAAA,EAAAA,EAAjB,YAAiBA,CAAjB;AACAN,MAAAA,MAAM,CAANA,GAAM,CAANA,GAAAA,QAAAA;AACAC,MAAAA,OAAO,CAAPA,GAAO,CAAPA,GAAAA,QAAAA;AACD;AAPHG,GAAAA;AASD;;AAED,SAAA,gBAAA,CAAA,EAAA,EAAA,SAAA,EAAyC;AACvC,OAAK,MAAL,SAAA,IAAwBA,MAAM,CAANA,mBAAAA,CAAxB,SAAwBA,CAAxB,EAA+D;AAC7D,QAAIK,SAAS,KAAb,WAAA,EAA+B;AAC7BC,MAAAA,iBAAiB,CAAA,EAAA,EAAK;AAAA,QAAA,SAAA;AAAYV,QAAAA,MAAM,EAAEN,EAAE,CAAtB,IAAA;AAA6BO,QAAAA,OAAO,EAAEP;AAAtC,OAAL,CAAjBgB;AACD;AACF;AACF;;AAGD,SAAA,iBAAA,CAAA,EAAA,SAA6D;AAAA,MAA9B;AAAA,IAAA,SAAA;AAAA,IAAA,MAAA;AAAoBT,IAAAA;AAApB,GAA8B;AAC3D,QAAMU,QAAQ,GAAGC,wBAAwB,CAAzC,SAAyC,CAAzC;AACAC,EAAAA,MAAM,CAANA,QAAM,CAANA;AAEA,QAAM;AAACC,IAAAA,IAAI,GAAG;AAAR,MAAN,QAAA;AACA,QAAM;AAACC,IAAAA,MAAM,GAAG;AAAV,MAAN,IAAA;AAEA,QAAMC,GAAG,GAAGtB,EAAE,CAAFA,YAAAA,CAAZ,SAAYA,CAAZ;;AAEA,OAAK,MAAL,GAAA,IAAkBU,MAAM,CAANA,IAAAA,CAAlB,QAAkBA,CAAlB,EAAyC;AACvC,UAAMa,MAAM,GAAI,GAAEZ,GAAI,GAAEU,MAAxB,EAAA;AAEA,QAAIP,QAAQ,GAAZ,IAAA;;AACA,QAAIH,GAAG,KAAP,MAAA,EAAoB,CAApB,CAAA,MAEO,IAAI,OAAOX,EAAE,CAAT,GAAS,CAAT,KAAJ,UAAA,EAAmC,CAAnC,CAAA,MAEA,IAAIsB,GAAG,IAAI,OAAOA,GAAG,CAAV,MAAU,CAAV,KAAX,UAAA,EAA8C;AAEnDR,MAAAA,QAAQ,GAAG;AAAA,eAAaQ,GAAG,CAAHA,MAAG,CAAHA,CAAxBR,YAAwBQ,CAAb;AAAA,OAAXR;AAFK,KAAA,MAGA,IAAI,OAAOG,QAAQ,CAAf,GAAe,CAAf,KAAJ,UAAA,EAAyC;AAE9CH,MAAAA,QAAQ,GAAGG,QAAQ,CAARA,GAAQ,CAARA,CAAAA,IAAAA,CAAXH,MAAWG,CAAXH;AACD;;AAED,QAAA,QAAA,EAAc;AACZR,MAAAA,MAAM,CAANA,GAAM,CAANA,GAAAA,QAAAA;AACAC,MAAAA,OAAO,CAAPA,GAAO,CAAPA,GAAAA,QAAAA;AACD;AACF;AACF","sourcesContent":["// WebGL1/WebGL2 extension polyfill support\n//\n// Provides a function that creates polyfills for WebGL2 functions based\n// on available extensions and installs them on a supplied target (could be\n// the WebGLContext or its prototype, or a separate object).\n//\n// This is intended to be a stand-alone file with minimal dependencies,\n// easy to reuse or repurpose in other projects.\n\n/** @typedef {import('./polyfill-context')} types */\n\nimport {polyfillVertexArrayObject} from './polyfill-vertex-array-object';\nimport {assert} from '../utils/assert';\n\nimport {WEBGL2_CONTEXT_POLYFILLS, WEBGL2_CONTEXT_OVERRIDES} from './polyfill-table';\n\n/** @type {types['polyfillContext']} */\nexport function polyfillContext(gl) {\n  // @ts-ignore\n  gl.luma = gl.luma || {};\n  // @ts-ignore\n  const {luma} = gl;\n\n  if (!luma.polyfilled) {\n    polyfillVertexArrayObject(gl);\n    initializeExtensions(gl);\n    installPolyfills(gl, WEBGL2_CONTEXT_POLYFILLS);\n    installOverrides(gl, {target: luma, target2: gl});\n    luma.polyfilled = true;\n  }\n\n  // TODO - only supporting a few members\n  /** @type {WebGL2RenderingContext} */\n  // @ts-ignore\n  return gl;\n}\n\n// TODO - is this still required?\nconst global_ = typeof global !== 'undefined' ? global : window;\n// @ts-ignore\nglobal_.polyfillContext = polyfillContext;\n\nfunction initializeExtensions(gl) {\n  gl.luma.extensions = {};\n  // `getSupportedExtensions` can return null when context is lost.\n  const EXTENSIONS = gl.getSupportedExtensions() || [];\n  for (const extension of EXTENSIONS) {\n    gl.luma[extension] = gl.getExtension(extension);\n  }\n}\n\n// Install simple overrides (mostly get* functions)\nfunction installOverrides(gl, {target, target2}) {\n  Object.keys(WEBGL2_CONTEXT_OVERRIDES).forEach(key => {\n    if (typeof WEBGL2_CONTEXT_OVERRIDES[key] === 'function') {\n      // install an override, if no implementation was detected\n      const originalFunc = gl[key] ? gl[key].bind(gl) : () => {};\n      const polyfill = WEBGL2_CONTEXT_OVERRIDES[key].bind(null, gl, originalFunc);\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  });\n}\n\nfunction installPolyfills(gl, polyfills) {\n  for (const extension of Object.getOwnPropertyNames(polyfills)) {\n    if (extension !== 'overrides') {\n      polyfillExtension(gl, {extension, target: gl.luma, target2: gl});\n    }\n  }\n}\n\n// Polyfills a single WebGL extension into the `target` object\nfunction polyfillExtension(gl, {extension, target, target2}) {\n  const defaults = WEBGL2_CONTEXT_POLYFILLS[extension];\n  assert(defaults);\n\n  const {meta = {}} = defaults;\n  const {suffix = ''} = meta;\n\n  const ext = gl.getExtension(extension);\n\n  for (const key of Object.keys(defaults)) {\n    const extKey = `${key}${suffix}`;\n\n    let polyfill = null;\n    if (key === 'meta') {\n      // ignore\n    } else if (typeof gl[key] === 'function') {\n      // WebGL2 implementation is already\n    } else if (ext && typeof ext[extKey] === 'function') {\n      // pick extension implemenentation,if available\n      polyfill = (...args) => ext[extKey](...args);\n    } else if (typeof defaults[key] === 'function') {\n      // pick the mock implementation, if no implementation was detected\n      polyfill = defaults[key].bind(target);\n    }\n\n    if (polyfill) {\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}